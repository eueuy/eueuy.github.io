---
layout: post
title: 《Distributed Systems for fun and profit》笔记
author: zhangyue
---
## Distributed Systems for fun and profit

## 分布式系统的高层概念 Distributed systems at high level
* 分布式系统
    *  为了提高存储和计算能力
* 分布式系统的目标：可扩展和其它
    * 扩展性
    * 性能和延迟
    * 可用性和容错
* 物理因素带给我们的限制
    * 节点数量： 节点越多则节点失败和通信失败可能性增加
    * 节点间的距离： 最小延迟增加
* 分布式系统的抽象和模型
    * 系统模型（同步/异步）
    * 故障模型（故障容忍/分区容忍）
    * 一致性模型（一致、最终一致）
* 分布式技术：分区和复制
    * 分区和复制体现了分治思想
    * 分区
        * 提高性能：拆解数据
        * 提高可用性：允许部分数据失效
        * 考虑如何分区
            * Hash
            * 一致性Hash
            * 按范围
        * 损失：高跨区访问成本
    * 复制
        * 提高性能：并行处理，提高速度
        * 提高可用性：备份允许丢失，提高容错性
        * 挑战：会产生副本一致性问题
            
## 分布式系统的抽象探索 Up and down the level       

* 抽象和模型
    * 简化和聚焦问题  
* 分布式系统的模型
    * 节点
    * 通信链接
    * 时间和顺序
    * 共识（一致性）问题
    * 两个不可能结果
* FLP不可能结果
* CAP定理
* 强一致性模型和其它一致性模型
    * 强一致性模型
    * 客户端一致性模型（客户端或会话一致性）
    * 最终一致性
    
    
## 分布式系统中的时间和顺序 Time and order
* 时间和顺序
    * 像单机系统一样有同样的执行顺序
* 全局有序和偏序
* 什么是时间
* 分布式节点的时间相同吗
    * 全局时钟
    * 本地时钟
    * 无时钟
* 时间在分布式系统中的作用
    * 定义系统中的顺序
        * 系统的正确性取决于正确的顺序
        * 冲突协调需要顺序作为评判标准
    * 定义边界条件（故障检测器）
* 矢量时钟（计数器+通信）
    * Lamport Clock
    * Vector Clock
* 故障检测（心跳+定时器）
* 时间，顺序和性能
    * 分布式系统天生是偏序的
    * 全局有序需要额外的通信
    * 利用Single Node 可降低顺序保证难度（将需要有序的操作部分放在单个节点上同步执行）
    
## 复制：强一致性模型

* 复制
    * 复制要解决的是一组通信问题
        * 什么样的通信模式可以提供所需的性能和可用性？
        * 当网络分区或节点崩溃，如何保证容错性、持久性和一致性？
    * 复制的四个阶段
        * 客户端发送请求
        * 复制中的同步部分执行
        * 向客户端返回答复
        * 复制中的异步部分执行
* 同步复制
    * 是一种悲观复制
    * 性能取决于最慢的一个节点(N of N)
    * 提供很好的持久性和一致性保证
* 异步复制
    * 是一种乐观复制
    * 性能很快 (1 of N)
    * 提供很弱的持久性和一致性保证
* 主要复制方法
    * 防止分歧的 Single-Copy Systems
    * 允许分歧的 Multi-Master Systems
* Primay-Backup 主备复制协议
    * 异步主备复制（只需要一条信息 ：更新）
    * 同步主备复制（需要两条信息：更新+确认收到）
        * 仍然需要额外的协调来应对故障，保证持久性（主节点在任意时间可能失效）
        * 需要日志和2pc来做额外保证（失败回滚）
* 2PC 两阶段提交协议
    * 主要是允许失败回滚，防止故障导致的分歧
    * 无法做到分区容忍(N of N复制)
* 分区容忍一致性复制协议
    * 什么是网络分区
        * 无法区分远程节点崩溃还是网络故障
    * 大多数仲裁 Quorums
        * 获得大多数投票即可进行(N/2+1 of N)
        * 通过奇数节点保证分区时只有一个集群是活跃的
        * 允许少数派数据不一致，但少数派的数据会被放弃来保证一致性。（放弃活跃性保证安全性）
    * 节点区分角色
        * 一个Leader角色和多个Follower角色
    * 为选举区分纪元 Term
        * 充当逻辑时钟用于识别出已经过期的选票和Leader角色
    * Leader 变更机制
        * 要保证一旦做出一个决策，即使因为崩溃而更换Leader也不能丢失这个决策
    * 将纪元内的提案编号
        * 要保证一旦做出一个决策，即使因为崩溃或分区也不能丢失这个决策
    * 通常的操作流程
* 分区容忍一致性算法的代表：Paxos、Raft、ZAB
* 总结：具有强一致性的复制方法
    * Primay-Backup 主备模型(MySQL)
        * 基于日志的复制，从节点只读
        * 有复制延迟
        * 有单一且静态指定的主
        * 无法容错
    * 2PC
        * 一致表决
        * 无复制延迟
        * 静态主
        * 无法容错
    * Paxos类
        * 大多数机制
        * 动态指定主
        * 允许一部分节点失败或分区
        
        
## 复制：弱一致性模型
* 接受分歧
    * 允许暂时的分歧，找到某种处理分歧的方法，并最终返回一致可用的结果
    * 两种最终一致模型：
        * 概率最终一致
        * 保证最终一致
* 协调不同操作的顺序
    * 分区时允许多个副本被不同客户端写入不同的值(AP)
    * 利用协调协议处理写入冲突并收敛成一个可用的值
* Amazon's Dynamo
    * 数据分布技术：一致性哈希
    * 一致性保证技术：部分大多数仲裁 Partial Quorums (R+W>N)
    * R+W>N 是强一致性吗
    * 冲突检测和Read-Repair
        * 允许副本分歧的系统必须有办法最终协调两个不同的值
        * 这种协调方法必须依赖一些元数据
            * 没有元数据：Last Write Win
            * 依赖时间戳:   Global Clock
            * 依赖版本号：Lamport Clock
            * 依赖向量时钟：Vector Clock (准确跟踪因果关系的最小实现）
        * 读取修复依然可能会返回多个值
    * 副本同步技术：Gossip 协议和 Merkle Tree
* 无序编程
    * 一些数据类型在任意操作顺序下都会收敛为同一个值
* CRDT : Conflict-free replicated data types
    * CRDT的三律
        * 交换律、组合率、幂等律
    * 常见的CRDT结构
        * Counter
        * Register
        * Set / PN Set
* CALM定理
* 非单调性有什么好处

## References     
* 《Distributed systems for fun and profit》 http://book.mixu.net/distsys/eventual.html
* 中文翻译
    * https://www.jianshu.com/p/933b2cef5108                                              
    * https://www.jianshu.com/p/7c5c7cee1ff3        
