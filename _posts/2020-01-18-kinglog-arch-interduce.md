---
layout: post
title: PB级日志服务Kinglog解构：基本架构
author: zhangyue
---

## Kinglog简介
Kinglog 是随手记从2016年开始建设的分布式实时日志分析平台。目前覆盖随手记几乎全部的日志和事件分析需求，以及作为时间序列和大部分监控系统的底层存储。

Kinglog 基于 ElasticSearch 多集群架构实现。通过对扩展性、可用性、成本、性能、
自动化、功能性 6 个方面的优化，实现了PB级日志存储和分析。且在此规
模下拥有极小的Lag，查询可以保证秒级返回，支持多租户逻辑和物理隔离。做到了整
体可用性 99.99% 和接近 0 运维的自动化能力。

本系列文章将自顶向下的介绍整个Kinglog日志服务的设计和实现，以及4年来我们遇到的问题。

## Kinglog主要特性

Kinglog构建于Elasticsearch引擎之上，通过以下几个方向上的工作，实现一个成熟稳定的日志服务。

* 扩展性优化
    * 利用多集群架构实现弹性扩展
* 可用性优化
	* 多租户资源隔离
	* 读写限流、熔断
	* 热点调度
	* 同城两地三中心部署
	* 双写灾备
* 成本优化
	* 冷热分离
	* 降精度&预聚合
	* 按需加载
* 性能优化
    * 写入并发度优化
    * 大跨度查询的串行化返回
    * 查询减枝
    * 分片分配优化
* 自动化
    * 自动生命周期
    * 自动调度
* 功能扩展
    * SQL Layer
    * Context Lookup
    * Log Reduce
    * 时序API

接下来我将介绍我们是怎么用一副架构做到这些点的。

## 整体架构

Kinglog是一个分布式系统，包括4个组件：Repository Manager、Shipper、Proxy、Application Service。这些组件围绕着多个规模不等的Elasticsearch集群来工作。

![](/assets/img/blog/2020-01-18-kinglog-arch-interduce.png)

**Repository Manager**

RM负责处理整个ES集群的调度、管理系统的Metadata信息。RM通过Metadata以仓库为单位控制日志在集群中的写入、存储、读取等关键行为。是整个系统的大脑。

RM还负责调度和维护ES的索引和分片，它会根据Meta信息产生Priority Task List，之后向ES集群发送命令，保证将ES集群的状态同步到和meta描述一致。

RM将Meta信息存储在zk中，利用zk实现数据安全和线性读写能力。RM通常会部署3个节点，一个主节点提供服务，两个从节点用于容错。

**Shipper Cluster**

Shipper负责从数据源拉取数据并写入到正确的ES集群中，过程中要解决资源隔离、故障隔离、并发协调、写入优化、弹性扩容等一系列写入问题。
Shipper基于分布式任务调度框架构建，可以任意弹性扩展，具备自动失效转移能力。

**Proxy Cluster**

Proxy Cluster 负责将用户的检索请求Routing到正确的ES集群，并处理资源隔离、查询加速、分批返回、熔断、SQL解析、数据安全等读取问题。
Proxy 集群是无状态的，可以无限扩展。


**Application Service**

Application Service 负责实现基于日志的应用层功能，包括日志归类、日志告警、上下文查询等。大多是计算性的任务。
Application 服务是无状态的。可以随意扩展。通常并部署在负载均衡器之后。


## 集群的工作原理

在集群内，日志数据是以“仓库”为粒度处理的，一个仓库是一个完整的数据集，所有对数据的操作和调度都是基于仓库。meta就是用来描述仓库的样子。


仓库模型的目的是降低数据调度和管理的复杂性，可以用一个处理模型处理所有数据，并隐藏诸如多集群、生命周期处理、容灾等细节，为调度管理提供一个清晰的界面

从抽象角度来看，一个仓库通常包扩以下资源，虽然提供这些资源的服务是分散的：
* 数个队列
* 数个写入线程
* 数个ES索引
* 一个ES别名
* 可能有数个HDFS文件

RM服务会管理数万个这样的仓库并进行自动调度。比如RM发现某个仓库的流量暴增，可能会将这个仓库的优先级降低，至于如何安全实现消费速率的降低，就由仓库内部来保证。

比如我们要新建一个仓库，RM会新建一份基准配置的meta ，那么其他组件会sync到这份meta ，并apply。RM中的Curator模块会让ES创建出索引，Shipper 会创建出投递任务待命， 当数据进入kafka，这个仓库就运转起来了。当有查询请求过来，Proxy服务则会通过meta了解到应该去哪个ES集群执行怎样的请求。

可以看到集群内的组件职责是完全分离的，集群工作起来后RM组件负责进行仓库调度管理工作，并将决定写入meta中。其他组件则根据meta信息产生自己的任务并执行。
  
## 总结

本篇作为系列文章的开头，主要介绍了Kinglog服务的背景，以及其主体架构的设计和工作原理，提供了一个全貌。后续的文章中我将深入部分细节，介绍具体的设计和实现。